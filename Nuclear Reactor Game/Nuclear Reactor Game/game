import pygame
import sys

#initialize pygame:
pygame.init()
pygame.mixer.init()  #initialize sound mixer

#screen settings:
WIDTH, HEIGHT = 800, 600
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption('Loading Image')
pygame.display.set_caption("Nuclear Reactor Constructor")

#images:
bg = pygame.image.load('bg_screen.png')
success_screen = pygame.image.load('success_screen.png')
steam_generator = pygame.image.load('steam_generator.png').convert_alpha() 
reactor_core = pygame.image.load('reactor_core.png').convert_alpha() 
generator = pygame.image.load('generator.png').convert_alpha() 

#colors:
WHITE = (255, 255, 255)
GREEN = (0, 200, 0)
BLACK = (0, 0, 0)
RED = (200, 0, 0)
BLUE = (0, 0, 200)
YELLOW = (200, 200, 0)

#fonts:
font = pygame.font.SysFont(None, 60)
small_font = pygame.font.SysFont(None, 40)

#sounds:

fail_sound = pygame.mixer.Sound("boom.wav")
win_sound = pygame.mixer.Sound("yippee.wav")



def create_game_state():
    """Initialize or reset the game state."""
    #remember original positions for snapback
    parts = [
        {
            "name": "Reactor",
            "image": reactor_core,
            "rect": reactor_core.get_rect(topleft=(100, 10)),
            "original_pos": (100, 10),
            "placed": False
        },
        {
            "name": "Generator",
            "image": generator,
            "rect": generator.get_rect(topleft=(300, 10)),
            "original_pos": (300, 10),
            "placed": False
        },
        {
            "name": "Cooling System",
            "image": steam_generator,
            "rect": steam_generator.get_rect(topleft=(500, 10)),
            "original_pos": (500, 10),
            "placed": False
        }
    ]

    #slots
    slots = [
        {"id": 1, "rect": pygame.Rect(123, 276, 80, 80), "part": "Cooling System", "filled": False},
        {"id": 2, "rect": pygame.Rect(186, 392, 80, 80), "part": "Reactor", "filled": False},
        {"id": 3, "rect": pygame.Rect(383, 473, 80, 80), "part": "Generator", "filled": False}
    ]

    return parts, slots, 0, False, False  # parts, slots, current_slot_index, game_over, game_won


def draw_restart_button():
    """Draw and return the restart button rect"""
    button_rect = pygame.Rect(WIDTH // 2 - 100, HEIGHT - 100, 200, 60)
    pygame.draw.rect(screen, GREEN, button_rect, border_radius=10)
    text = small_font.render("RESTART", True, BLACK)
    screen.blit(text, (button_rect.centerx - text.get_width() // 2, button_rect.centery - text.get_height() // 2))
    return button_rect


#initialize game state:
parts, slots, current_slot_index, game_over, game_won = create_game_state()
dragging_part = None
offset_x, offset_y = 0, 0

#game loop:
clock = pygame.time.Clock()
running = True
while running:
    screen.fill(WHITE)  #background
    screen.blit(bg, (0,0))

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit()
            sys.exit()

        #handle restart button if game over or won:
        if game_over or game_won:
            if event.type == pygame.MOUSEBUTTONDOWN:
                mouse_pos = event.pos
                if restart_button.collidepoint(mouse_pos):
                    parts, slots, current_slot_index, game_over, game_won = create_game_state()
            continue  #skip normal game logic

        #dragging
        if event.type == pygame.MOUSEBUTTONDOWN:
            mouse_pos = event.pos
            for part in parts:
                if part["rect"].collidepoint(mouse_pos) and not part["placed"]:
                    dragging_part = part
                    offset_x = part["rect"].x - mouse_pos[0]
                    offset_y = part["rect"].y - mouse_pos[1]
                    break

        #drop part
        if event.type == pygame.MOUSEBUTTONUP:
            if dragging_part:
                dropped_on_slot = False
                for slot in slots:
                    if not slot["filled"] and slot["rect"].colliderect(dragging_part["rect"]):
                        dropped_on_slot = True
                        if slot["part"] == dragging_part["name"]:
                            #correct slot
                            dragging_part["rect"].topleft = slot["rect"].topleft
                            dragging_part["placed"] = True
                            slot["filled"] = True
                            #check win condition
                            if all(slot["filled"] for slot in slots):
                                game_won = True
                                win_sound.play()
                        else:
                            #wrong slot triggers game over
                            game_over = True
                            fail_sound.play()
                        break  #only allow one slot per drop

                if not dropped_on_slot:
                    #snap back if not dropped on any slot
                    dragging_part["rect"].topleft = dragging_part["original_pos"]

                dragging_part = None
        #dragging movement
        if event.type == pygame.MOUSEMOTION and dragging_part:
            mouse_x, mouse_y = event.pos
            dragging_part["rect"].x = mouse_x + offset_x
            dragging_part["rect"].y = mouse_y + offset_y

    #show game over screen
    if game_over:
        screen.fill(RED)
        text = font.render("MELTDOWN!", True, BLACK)
        screen.blit(text, (WIDTH // 2 - text.get_width() // 2, 150))
        restart_button = draw_restart_button()
        pygame.display.flip()
        clock.tick(60)
        continue

    #show win screen
    if game_won:
        screen.blit(success_screen, (0, 0))
        text = font.render("REACTOR ONLINE!", True, BLACK)
        screen.blit(text, (WIDTH // 2 - text.get_width() // 2, 150))
        restart_button = draw_restart_button()
        pygame.display.flip()
        clock.tick(60)
        continue

    #draw parts (using images)
    for part in parts:
        screen.blit(part["image"], part["rect"])

    pygame.display.flip()
    clock.tick(60)


